import streamlit as st
from openai import OpenAI

# üëâ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ API key ‡¶¨‡¶∏‡¶æ‡¶ì
API_KEY = "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"   # ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶Ü‡¶∏‡¶≤ API key ‡¶¶‡¶æ‡¶ì
client = OpenAI(api_key=API_KEY)

# Streamlit Config
st.set_page_config(page_title="‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶è‡¶Ü‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü ü§ñ", page_icon="ü§ñ", layout="centered")

# Custom Dark CSS
st.markdown("""
    <style>
        .stApp {
            background-color: #121212;
            font-family: 'Noto Sans Bengali', sans-serif;
            color: #f1f1f1;
        }
        .chat-bubble-user {
            background-color: #1e88e5;
            color: white;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 6px 0;
            text-align: right;
            display: inline-block;
            max-width: 75%;
            box-shadow: 0px 3px 6px rgba(0,0,0,0.3);
        }
        .chat-bubble-ai {
            background-color: #2c2c2c;
            color: #f1f1f1;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 6px 0;
            text-align: left;
            display: inline-block;
            max-width: 75%;
            border: 1px solid #444;
            box-shadow: 0px 3px 6px rgba(0,0,0,0.3);
        }
        .chat-container {
            max-height: 65vh;
            overflow-y: auto;
            padding: 12px;
            border-radius: 12px;
            background-color: #1a1a1a;
            margin-bottom: 10px;
        }
        .stTextInput input {
            font-size: 16px;
            padding: 10px;
            border-radius: 8px;
            background-color: #2c2c2c;
            color: #f1f1f1;
            border: 1px solid #444;
        }
    </style>
""", unsafe_allow_html=True)

# Title
st.markdown("<h2 style='text-align:center; color:#90caf9;'>ü§ñ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶è‡¶Ü‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡¶¨‡¶ü MADE BY SAKIB</h2>", unsafe_allow_html=True)
st.markdown("<p style='text-align:center; color:gray;'>üí¨ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ï‡¶∞‡ßã, ‡¶è‡¶Ü‡¶á ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá</p>", unsafe_allow_html=True)

# Session state messages
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": "‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡¶π‡¶æ‡ßü‡¶ï AI ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶ü, ‡¶∏‡¶¨ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶¶‡ßá‡¶¨‡ßá‡•§"}
    ]

# ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
st.markdown("<div class='chat-container'>", unsafe_allow_html=True)
for msg in st.session_state.messages[1:]:
    if msg["role"] == "user":
        st.markdown(f"<div class='chat-bubble-user'>üë§ {msg['content']}</div>", unsafe_allow_html=True)
    elif msg["role"] == "assistant":
        st.markdown(f"<div class='chat-bubble-ai'>ü§ñ {msg['content']}</div>", unsafe_allow_html=True)
st.markdown("</div>", unsafe_allow_html=True)

# ‡¶á‡¶®‡¶™‡ßÅ‡¶ü
prompt = st.chat_input("‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...")
if prompt:
    st.session_state.messages.append({"role": "user", "content": prompt})
    st.markdown(f"<div class='chat-bubble-user'>üë§ {prompt}</div>", unsafe_allow_html=True)

    # AI ‡¶â‡¶§‡ßç‡¶§‡¶∞
    reply = ""
    response = client.chat.completions.create(
        model="gpt-4o-mini",   # ‚úÖ gpt-5 ‡¶è‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá valid model ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßã
        messages=st.session_state.messages,
        stream=True
    )

    reply_placeholder = st.empty()
    for chunk in response:
        if chunk.choices[0].delta.content:
            text = chunk.choices[0].delta.content   
            reply += text
            reply_placeholder.markdown(f"<div class='chat-bubble-ai'>ü§ñ {reply}</div>", unsafe_allow_html=True)

    st.session_state.messages.append({"role": "assistant", "content": reply})
